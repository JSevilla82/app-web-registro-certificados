{% extends "base.html" %}
{% set active="admin" %}

{% block title %}Certificados Admin · Cabildo Indígena de la Peñata{% endblock %}

{% block content %}
<section class="hero">
  <div class="container">
    <h2>Certificados (Admin)</h2>
    <p>Genere certificados desde el panel administrativo. Para mayor control, primero se valida el documento en el censo y luego confirma la emisión.</p>
  </div>
</section>

<div class="cards-stack">
  <div class="card" id="adminCertCard" data-min-transition="{{ ui_min_transition_seconds|default(2) }}">

    <!-- Paso 1: Formulario -->
    <div id="adminCertStepForm">
      <form id="adminCertForm" novalidate>
        <div class="form-group">
          <label for="adminDocNumber">Número de Documento</label>
          <input id="adminDocNumber" type="tel" inputmode="numeric" placeholder="Ingrese solo números" required>
        </div>

        <div id="adminFormError" style="display:none; background:#ffebee; color:#b71c1c; padding:12px; border-radius:12px; margin-bottom: 14px; text-align:center;">
          <strong style="display:block; margin-bottom:4px;">Atención</strong>
          <span id="adminFormErrorText"></span>
        </div>

        <button id="adminBtnGenerar" type="submit" class="btn-submit">
          <i data-lucide="arrow-right" aria-hidden="true"></i>
          <span>Continuar</span>
        </button>

        <div style="margin-top: 14px; text-align:center;">
          <a href="{{ url_for('admin_panel') }}" class="btn-secondary" style="width:auto; min-width: 200px; text-decoration:none; display:inline-flex; align-items:center; justify-content:center;">
            Volver al panel
          </a>
        </div>
      </form>
    </div>

    <!-- Paso 2: Confirmación (previo a generar) -->
    <div id="adminCertStepConfirm" style="display:none;">
      <div style="background:#f5f7fa; border:1px solid #e5ebf2; padding:12px; border-radius:14px; margin-bottom: 14px;">
        <p style="margin:0; font-weight: 700;" id="adminConfirmNombre"></p>
        <p style="margin:4px 0 0 0; color:#666; font-size: 0.92rem;" id="adminConfirmDoc" class="doc-mask"></p>
      </div>

      <div style="background:#fff; border:1px solid #e6ebf1; padding:14px; border-radius:14px; margin-bottom: 14px;">
        <div style="font-weight:700; margin-bottom:6px;">Revise la información antes de generar</div>
        <div style="color:#667085; font-size:0.92rem;">Si todo está correcto, continúe con la emisión del certificado.</div>
      </div>

      <div style="display:flex; gap:10px; flex-wrap: wrap; justify-content:center;">
        <button id="adminBtnAtras" type="button" class="btn-secondary" style="width:auto; min-width: 200px;">
          <i data-lucide="arrow-left" aria-hidden="true"></i>
          <span>Atrás</span>
        </button>
        <button id="adminBtnGenerarFinal" type="button" class="btn-submit" style="width:auto; min-width: 200px;">
          <i data-lucide="file-plus" aria-hidden="true"></i>
          <span>Generar certificado</span>
        </button>
      </div>

      <div style="margin-top: 12px; display:flex; gap:10px; flex-wrap: wrap; justify-content:center;">
        <a href="{{ url_for('admin_panel') }}" class="btn-secondary" style="width:auto; min-width: 200px; text-decoration:none; display:inline-flex; align-items:center; justify-content:center;">
          <i data-lucide="layout-dashboard" aria-hidden="true"></i>
          <span>Volver al panel</span>
        </a>
      </div>
    </div>

    <!-- Paso intermedio: Transición -->
    <div id="adminCertStepLoading" style="display:none; text-align:center; padding: 8px 0;">
      <div class="inline-loader">
        <div class="inline-loader__spinner"></div>
        <h3 id="adminLoadingTitle" style="margin: 16px 0 6px 0;">Procesando...</h3>
        <p id="adminLoadingSubtitle" style="margin:0; color:#666; font-size: 0.95rem;">Por favor espere</p>
      </div>
    </div>

    <!-- Paso 3: Listo -->
    <div id="adminCertStepReady" style="display:none; text-align: center; padding: 10px 0;">
      <div style="background: #e8f5e9; color: #2e7d32; padding: 15px; border-radius: 12px; margin-bottom: 14px;">
        <h3 style="margin:0;">Tu documento está listo</h3>
        <p style="margin:6px 0 0 0; font-size: 0.9rem;" id="adminReadyMsg">Puede descargarlo.</p>
      </div>

      <p style="margin-bottom: 5px; font-weight: bold;" id="adminResNombre"></p>
      <p style="color: #666; font-size: 0.9rem;" id="adminResDoc" class="doc-mask"></p>
      <p style="color: #666; font-size: 0.85rem; margin-top: 6px;">Código de verificación: <span id="adminResCodigo" style="font-family: monospace;"></span></p>

      <hr style="margin: 20px 0; border: 0; border-top: 1px solid #eee;">

      <div style="display:flex; gap:10px; justify-content:center; flex-wrap: wrap;">
        <a id="adminBtnDescargar" href="#" class="btn-submit" style="text-decoration: none; display: inline-block; background: #2e7d32; width:auto; padding: 12px 16px;">
          DESCARGAR
        </a>

        <a id="adminBtnVerCertificado" href="#" target="_blank" rel="noopener" class="btn-submit" style="text-decoration: none; display: inline-block; background: #1565c0; width:auto; padding: 12px 16px;">
          VER CERTIFICADO
        </a>
      </div>

      <p style="margin-top: 14px; color:#666; font-size:0.85rem;">
        Verificación pública: <br>
        <a id="adminVerifyLink" href="#" target="_blank" style="word-break: break-all; color: var(--primary); text-decoration: underline;"></a>
      </p>

      <div style="margin-top: 12px; display:flex; gap:10px; flex-wrap: wrap; justify-content:center;">
        <button id="adminBtnOtraConsulta" type="button" class="btn-secondary" style="width:auto; min-width: 200px;">Generar otro</button>
        <a href="{{ url_for('admin_panel') }}" class="btn-secondary" style="width:auto; min-width: 200px; text-decoration:none; display:inline-flex; align-items:center; justify-content:center;">
          Volver al panel
        </a>
      </div>

      <p style="margin-top: 12px; color:#777; font-size:0.82rem;">
        La herramienta mantiene un único certificado por día para este mismo origen (Admin). Al cambiar la fecha se emitirá uno nuevo.
      </p>
    </div>

    <!-- Error -->
    <div id="adminCertStepError" style="display:none; text-align: center; padding: 10px 0;">
      <div style="background: #ffebee; color: #b71c1c; padding: 15px; border-radius: 12px; margin-bottom: 20px;">
        <h3 style="margin:0;">No fue posible continuar</h3>
        <p style="margin:6px 0 0 0; font-size: 0.9rem;" id="adminCertErrorText"></p>
      </div>

      <div style="display:flex; gap:10px; flex-wrap: wrap; justify-content:center;">
        <button id="adminBtnReintentar" type="button" class="btn-submit" style="background: var(--primary); width:auto; min-width: 200px;">
          Intentar de nuevo
        </button>
        <a href="{{ url_for('admin_panel') }}" class="btn-secondary" style="width:auto; min-width: 200px; text-decoration:none; display:inline-flex; align-items:center; justify-content:center;">
          Volver al panel
        </a>
      </div>
    </div>

  </div>
</div>

{% endblock %}

{% extends "base.html" %}

{% block content %}
<section class="hero">
  <div class="container">
    <h2>Verificar certificados</h2>
    <p>Ingrese el código de verificación para validar un certificado.</p>
  </div>
</section>

<div class="home-wrap" style="margin-top: -40px;">

  <div class="card home-card">
    <h3 style="margin: 0 0 10px 0;">Verificación de documentos</h3>
    <p class="home-text" style="margin-bottom: 14px;">
      Puede ingresar el código manualmente o pegarlo desde el enlace recibido.
    </p>

    <form method="get" action="{{ url_for('publico.verificar_certificados') }}" class="verify-inline-form">
      <div class="verify-inline-form__row">
        <input
          type="text"
          name="codigo"
          value="{{ codigo or '' }}"
          placeholder="Código de verificación"
          maxlength="64"
          autocomplete="off"
          class="verify-inline-form__input"
          required
        >
        <button type="submit" class="btn-submit verify-inline-form__btn">VERIFICAR</button>
      </div>
    </form>
  </div>

  <div id="verifyLoading" class="card home-card" data-enable="{{ 1 if show_loader else 0 }}" style="text-align:center; {% if not show_loader %}display:none;{% endif %}">
    <div class="inline-loader">
      <div class="inline-loader__spinner"></div>
      <h3 style="margin: 16px 0 6px 0;">Validando certificado...</h3>
      <p style="margin:0; color:#666; font-size:0.95rem;">Consultando el sistema de verificación</p>
    </div>
  </div>

  <div id="verifyContent" {% if show_loader %}style="display:none;"{% endif %}>
    {% if found is none %}
      <div class="card home-card" style="text-align:center;">
        <p style="margin:0; color:#666;">Ingrese un código para ver el estado del certificado.</p>
      </div>
    {% elif found %}
      <div class="card home-card" style="text-align: center; border-top: 5px solid #2e7d32;">
        <h2 style="color: #2e7d32;">Documento verificado</h2>
        <p>Este certificado fue generado desde la plataforma oficial del Cabildo.</p>

        <div style="background: #f1f8f1; padding: 20px; border-radius: 12px; margin: 20px 0; text-align: left; border: 1px solid #c8e6c9;">
          <p><strong>Nombre:</strong> {{ c.nombre_completo }}</p>
          <p><strong>Identificación:</strong> {{ c.tipo_documento }} ********{{ c.numero_documento[-3:] }}</p>
          <p><strong>Tipo:</strong> {{ 'Certificado especial' if doc.tipo_documento == 'certificado_especial' else 'Certificado de afiliación' }}</p>
          {% if c.activo %}
            <p><strong>Estado:</strong> Miembro Activo</p>
          {% else %}
            <p><strong>Estado:</strong> <span style="color:#b71c1c;">Usuario no afiliado</span></p>
            <p style="margin: 8px 0 0 0; color:#8a4f00; font-size:0.92rem;">
              Este certificado se generó mientras el usuario estaba afiliado. Actualmente figura como <strong>no afiliado</strong> al Cabildo.
            </p>
          {% endif %}
          <p><strong>Fecha de emisión:</strong> {{ emision_str or doc.creado_en.strftime('%d/%m/%Y %I:%M %p') }}</p>
        </div>

        <p style="font-size: 0.8rem; color: #666;">Código de verificación:<br>
          <span style="font-family: monospace;">{{ doc.codigo }}</span>
        </p>

        {% if ver_doc_disponible and ver_doc_url %}
          <div style="margin-top: 14px;">
            <a href="{{ ver_doc_url }}" target="_blank" rel="noopener" class="btn-submit" style="text-decoration:none; display:inline-block; width:auto; padding: 12px 16px; background:#1565c0;">
              VER DOCUMENTO
            </a>
            <p style="margin: 10px 0 0 0; color:#666; font-size:0.85rem;">
              Este documento se muestra como copia para fines de verificación.
            </p>
          </div>
        {% else %}
          <p style="margin-top: 14px; color:#888; font-size:0.85rem;">
            La visualización del documento no está disponible porque fue eliminado por reglas de retención de datos ({{ retencion_dias }} días).
          </p>
        {% endif %}
      </div>
    {% else %}
      <div class="card home-card" style="text-align: center; border-top: 5px solid #d32f2f;">
        <h2 style="color: #d32f2f;">Documento no encontrado</h2>
        <p>El código de verificación no existe o el documento no es válido.</p>

        <div style="background: #ffebee; padding: 20px; border-radius: 12px; margin: 20px 0; text-align: left; border: 1px solid #ffcdd2;">
          <p style="margin:0; color:#b71c1c;">Verifique que la URL o el código QR estén completos y no hayan sido modificados.</p>
        </div>

        <p style="font-size: 0.8rem; color: #666;">Si el problema persiste, contacte al Cabildo.</p>
      </div>
    {% endif %}
  </div>

</div>
{% endblock %}
